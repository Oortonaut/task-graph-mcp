@startuml data-flow
!theme plain
skinparam backgroundColor #FEFEFE

title Data Flow - Task Lifecycle

participant "Agent" as agent
participant "MCP Server" as server
participant "ToolHandler" as tools
participant "Database" as db

== Connection ==
agent -> server : connect(worker_id, tags)
server -> tools : call_tool("connect", args)
tools -> db : register_worker()
db --> tools : worker record
tools --> server : {worker_id, paths}
server --> agent : result

== Task Discovery ==
agent -> server : list_tasks(ready=true)
server -> tools : call_tool("list_tasks", args)
tools -> db : query_tasks(filters)
db --> tools : task list
tools --> server : formatted tasks
server --> agent : claimable tasks

== Claiming ==
agent -> server : claim(worker_id, task)
server -> tools : call_tool("claim", args)
tools -> db : BEGIN TRANSACTION
tools -> db : check_dependencies()
tools -> db : check_tag_requirements()
tools -> db : update_task(status=in_progress)
tools -> db : record_state_transition()
tools -> db : COMMIT
db --> tools : claimed task
tools --> server : {success, task}
server --> agent : confirmation

== Working ==
agent -> server : thinking(worker_id, thought)
server -> tools : call_tool("thinking", args)
tools -> db : update_heartbeat()
tools -> db : update_current_thought()
db --> tools : ok
tools --> server : {success}
server --> agent : ack

== Completion ==
agent -> server : update(status=completed, attachments)
server -> tools : call_tool("update", args)
tools -> db : BEGIN TRANSACTION
tools -> db : update_task(status, attachments)
tools -> db : record_state_transition()
tools -> db : calculate_time_actual_ms()
tools -> db : find_unblocked_tasks()
tools -> db : COMMIT
db --> tools : {task, unblocked}
tools --> server : {task, unblocked}
server --> agent : result with unblocked list

@enduml
