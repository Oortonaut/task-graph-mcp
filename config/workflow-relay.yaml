# RELAY WORKFLOW - Sequential specialist handoffs, push coordination
# Flow: Designer -> Implementer -> Reviewer -> Tester
# Protocol: RECEIVE -> PROCESS -> DOCUMENT -> HANDOFF

name: relay
description: Specialists hand off work through phases like a relay race

settings:
  initial_state: pending
  disconnect_state: pending
  blocking_states: [pending, assigned, working]
  unknown_phase: warn

# Role definitions for specialists
roles:
  designer:
    description: Creates specifications and designs for features
    tags: [designer, design]
    phases: [design, explore]
    prompts:
      claim: |
        Design task. Deliver: problem statement, solution approach, interfaces, edge cases, acceptance criteria.
        Attach design doc for implementer handoff.
      handoff: "Ensure design spec attached, impl notes added, acceptance criteria explicit."

  implementer:
    description: Implements features based on designs
    tags: [implementer, implement, code]
    phases: [implement, integrate]
    prompts:
      claim: |
        Read design spec first. `mark_file()` before editing. Follow patterns. Tests alongside code.
        Never revert unfamiliar changes - check `mark_updates()`. Ask designer before guessing.
      handoff: "Ensure code committed, tests passing, self-reviewed, design deviations documented."

  reviewer:
    description: Reviews implementations for quality and correctness
    tags: [reviewer, review]
    phases: [review, security]
    prompts:
      claim: |
        Review against design spec. Check correctness, test coverage, edge cases, error handling, security.
        Document findings before approval/rejection.
      handoff: "Ensure approval/rejection clear. Rejected: list issues. Approved: note test focus areas."

  tester:
    description: Validates implementations through comprehensive testing
    tags: [tester, test, qa]
    phases: [test]
    prompts:
      claim: |
        Read design spec + acceptance criteria + review notes. Run suite, test edges and errors.
        Document results thoroughly.
      handoff: "Ensure results attached, pass/fail clear, failures documented or coverage noted."

# State configuration
states:
  pending:
    exits: [assigned, working, cancelled]
    timed: false

  assigned:
    exits: [working, pending, cancelled]
    timed: false
    prompts:
      enter: "Assigned by coordinator. Review and claim when ready, or reject to pending."

  working:
    exits: [completed, failed, pending, consult]
    timed: true
    prompts:
      enter: |
        **Relay working.** Protocol: receive attachments -> process -> document -> handoff.

        - Never revert unfamiliar changes: check `mark_updates()` / `list_marks()` first
        - `list_marks()` before editing for conflicts
        - 5+ files? Decompose first
        - `thinking()` regularly for heartbeat; `mark_updates()` every 30-60s
        - Stale workers (5+ min no heartbeat) get evicted
        - **Git lock**: `claim(task="_lock:git-commit")` -> commit -> release via `update(task="_lock:git-commit", status="pending")`

        Transitions: {{valid_exits}}
        Phase: {{current_phase}} | Valid: {{valid_phases}}

      exit: "Deliverables attached, handoff notes clear, files unmarked, `log_metrics()`."

  completed:
    exits: [pending]
    timed: false
    prompts:
      enter: "Phase complete. Coordinator routes to next specialist."

  failed:
    exits: [pending]
    timed: false
    prompts:
      enter: |
        Relay phase failed. **Recovery procedure:**

        1. **Preserve work:** `attach(type="error", content="...")` with what was attempted and what blocked
        2. **Clean up resources:**
           - `unmark_file()` all held files -- dangling marks block downstream specialists
           - Release any held locks: `update(task="_lock:git-commit", status="pending")` if you hold the git lock
        3. **Classify and route:**
           - *Spec unclear*: set back to `pending`, attach question -- coordinator routes back to designer
           - *Implementation defect found in review*: set `pending`, attach rejection details for implementer retry
           - *Test failure*: attach repro steps, set `pending` -- coordinator decides: fix-forward or rollback
           - *Needs human decision*: move to `consult` instead with the specific question
        4. **Relay chain impact:** document whether downstream phases should wait or proceed with partial results
        5. **Handoff note:** even on failure, attach a note for the next specialist or coordinator explaining
           what was completed, what remains, and recommended next step

  consult:
    exits: [working, pending, cancelled]
    timed: false
    prompts:
      enter: |
        **Paused for human review.** Before pausing:
        1. `unmark_file()` all held files -- downstream specialists should not be blocked
        2. Release any locks: `update(task="_lock:git-commit", status="pending")` if held
        3. `attach(type="note", content="...")` explaining:
           - What specific decision or input is needed
           - Impact on downstream relay phases
           - What you have completed so far and what remains
        4. A human (or coordinator) must transition this back to `working` or `pending`

  cancelled:
    exits: []
    timed: false

# Phase configuration
phases:
  design:
    prompts:
      enter: "**Design.** Create spec for implementers. Output: design doc + testable acceptance criteria."
      exit: "Ensure spec attached (`gate/spec`), criteria testable, handoff notes included."

  implement:
    prompts:
      enter: "**Implement.** Build per design spec. `mark_file()` first. Ask designer if unclear."
      exit: "Ensure commit attached (`gate/commit`), impl notes attached, tests pass, handoff notes included."

  review:
    prompts:
      enter: "**Review.** Verify impl matches design. Be specific about issues."
      exit: "Ensure approval attached (`gate/approval`). Rejected: list fixes. Approved: note test focus."

  test:
    prompts:
      enter: "**Test.** Validate end-to-end. Document failures with repro steps."
      exit: "Ensure results attached (`gate/test-results`), pass/fail clear, coverage noted."

  explore:
    prompts:
      enter: "**Explore.** Investigate options pre-design. Attach findings for designer."
      exit: "Attach findings: constraints discovered, options evaluated."

  integrate:
    prompts:
      enter: "**Integrate.** Merge with broader system. Coordinate via `mark_file()`."
      exit: "Ensure full test suite passes, no conflicts."

  security:
    prompts:
      enter: "**Security.** Input validation, auth/authz, secrets, dependency risks."
      exit: "Ensure findings attached, critical issues block relay until resolved."

  triage:
    prompts:
      enter: "**Triage.** Determine relay sequence, set tags for first specialist, capture requirements."
      exit: "Ensure requirements captured, routed to first specialist."

  diagnose:
    prompts:
      enter: "**Diagnose.** Reproduce, identify code paths, document fix approach for implementer."
      exit: "Ensure root cause documented, fix approach attached."

  plan:
    prompts:
      enter: "**Plan.** Outline relay sequence: which phases, which gate artifacts at each handoff."

  doc:
    prompts:
      enter: "**Document.** Update API docs, README, comments. Verify examples match implementation."

  deliver:
    prompts:
      enter: "**Deliver.** Verify all gate artifacts attached, full relay chain completed. Changelog if applicable."

  deploy:
    prompts:
      enter: "**Deploy.** Build verified, tests green. Tag release if applicable. Monitor post-deploy."

  monitor:
    prompts:
      enter: "**Monitor.** Watch for issues from delivered changes. Attach anomalies. Escalate regressions."

  optimize:
    prompts:
      enter: "**Optimize.** Measure baseline, targeted changes, re-measure. Keep only demonstrated improvements."

# State+Phase combos
combos:
  working+design:
    enter: "Designing. Deliverable = spec implementer can follow. Testable acceptance criteria."

  working+implement:
    enter: |
      Implementing per design spec. Ask designer about unclear requirements. Tests as you go.
      - **3+ files**: search ALL symbols first, mark_file() ALL, plan attachment before coding
      - **Git lock**: `claim(task="_lock:git-commit")` -> commit -> release

  working+review:
    enter: "Reviewing against design spec. Constructive. Distinguish blocking from suggestions."

  working+test:
    enter: "Testing against acceptance criteria. Repro steps for failures. Note untestable requirements."

  assigned+design:
    enter: "Design assigned. Check for exploration findings."

  assigned+implement:
    enter: "Implementation assigned. Design spec attached. Read fully before claiming."

  assigned+review:
    enter: "Review assigned. Design and impl ready. Familiarize before claiming."

  assigned+test:
    enter: "Test assigned. Design, impl, review complete. Check review for known issues."

  working+explore:
    enter: "Exploring pre-design. Time-box. Attach findings for designer. Focus on constraints."

  working+security:
    enter: "Security review. Check against design spec. Document for downstream specialists."

  working+integrate:
    enter: "Integration: merge, full test suite, coordinate via mark_file()."

  working+diagnose:
    enter: "Diagnosing: reproduce, narrow root cause, attach findings. Fix goes to implementer."

  failed+design:
    enter: |
      Design phase failed. Attach what was explored and why the design is blocked.
      Coordinator should route back to explore phase or bring in a different designer.

  failed+implement:
    enter: |
      Implementation failed. Before leaving:
      - `unmark_file()` all held files and release git lock if held
      - `attach(type="error")` with: files modified, tests that failed, build errors
      - If partially committed: attach the commit hash so reviewer can assess partial work
      - Note whether the design spec was sufficient or needs revision

  failed+review:
    enter: |
      Review rejected the implementation. Attach specific issues found.
      Coordinator routes back to implementer with the rejection details.

  failed+test:
    enter: |
      Testing failed. Attach: which tests failed, repro commands, whether this is a test bug or code bug.
      Coordinator decides: route back to implementer for fix, or to reviewer for re-assessment.

# Handoff protocol reference
handoff_protocol:
  flow:
    - { from: designer, to: implementer, via: "design spec attachment" }
    - { from: implementer, to: reviewer, via: "implementation + impl notes" }
    - { from: reviewer, to: tester, via: "review findings + approval" }
    - { from: tester, to: coordinator, via: "test results" }

# Gates (reject = required handoff artifacts)
gates:
  phase:design:
    - type: "gate/spec"
      enforcement: reject
      description: "Design spec required for implementer handoff"

  phase:implement:
    - type: "gate/commit"
      enforcement: reject
      description: "Commit hash required for reviewer"
    - type: "gate/impl-notes"
      enforcement: warn
      description: "Implementation notes explaining decisions"

  phase:review:
    - type: "gate/approval"
      enforcement: reject
      description: "Explicit approval/rejection with notes required"

  phase:test:
    - type: "gate/test-results"
      enforcement: reject
      description: "Test results required"

# Task tree templates
templates:
  feature:
    description: Standard feature development through relay phases
    tree:
      title: "{{feature_name}}"
      children:
        - title: "Design: {{feature_name}}"
          needed_tags: [designer]
          tags: [design]
        - title: "Implement: {{feature_name}}"
          needed_tags: [implementer]
          tags: [implement]
        - title: "Review: {{feature_name}}"
          needed_tags: [reviewer]
          tags: [review]
        - title: "Test: {{feature_name}}"
          needed_tags: [tester]
          tags: [test]
    sibling_type: follows

  bugfix:
    description: Bug fix through abbreviated relay
    tree:
      title: "Fix: {{bug_description}}"
      children:
        - title: "Diagnose: {{bug_description}}"
          needed_tags: [implementer]
          tags: [diagnose]
        - title: "Fix: {{bug_description}}"
          needed_tags: [implementer]
          tags: [implement]
        - title: "Verify: {{bug_description}}"
          needed_tags: [tester]
          tags: [test]
    sibling_type: follows

# Attachment types (compact reference)
attachments:
  handoff_deliverables:
    plan: Design spec (markdown, replaces)
    note: Phase observations for next specialist (appends)
    result: Phase outcome summary (JSON, replaces)
  code_artifacts:
    commit: Git commit hash (appends)
    diff: Code changes for review (appends)
    changelist: Files modified in phase (appends)
  quality:
    error: Issues found during review/testing (appends)
    output: Test execution output (appends)
    log: Phase activity log (appends)
  metadata:
    meta: Phase metrics (JSON, replaces)
    context: Critical info for downstream phases (replaces)
